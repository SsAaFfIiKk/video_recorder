## WebSocket Video Recorder ##

_Программа, позволяющая осуществлять запись видео на сервер посредством веб-браузера и протокола WebSocket._


__Запуск__

1. Клонировать репозиторий:  `git clone https://github.com/4in4in/video_recorder`

2. Установить зависимости: `npm i`

3. Запустить проект 

- в режиме разработчика (мгновенная перезагрузка при изменении кода): `npm run devStart`
- в обычном режиме: `npm start`


__Использование__

По умолчанию приложение запускается на адресе `https://0.0.0.0:8001`. Здесь и далее этот адрес будет использован в качестве примера. Изменить хост и порт запуска можо в файле `server.js` .

Страница записи видео находится по адресу `https://0.0.0.0:8001/record`.

Опциональные параметры GET-запроса:

| Параметр      | Тип данных  | Описание                                                    | По умолчанию
|:---           |:---         |:---                                                         |:---
| `name_prefix` | _str_       | Префикс для названия видеофайла, сохраняемого на сервере.   | `noname`
| `chunk_time`  | _int_       | Длительность фрагментов видео, передаваемых на сервер (мс). | `1000`

При переходе на эту страницу в браузере на страницу выводится видеопоток с веб-камеры; этот же видеопоток фрагментами с заданным интервалом отсылается на сервер.

Записанные видеофайлы в формате `webm` сохраняются в папке `./rec`. При использовании проекта в Docker-контейнере следует озаботиться созданием volume для нее. 

__Особенности запуска с Nginx__

Библиотека `socket.io` использует адрес `https://0.0.0.0:8001/socket.io`, что также нужно иметь в виду при внесении проекта в конфигурационный файл Nginx. Кроме того, ей необходим доступ к соединению по протоколу WSS — для этого библиотека отправляет на сервер запрос на т.н. `Connection Upgrade` с протокола HTTPS на WSS.

`Connection Upgrade` реализуется следующим образом.

>```
>...
>http {
>...
>
>    map $http_upgrade $connection_upgrade {
>        default upgrade;
>        ''      close;
>    }
>...
>    server {  
>    ...
>    
>      location /xxx/ {
>        proxy_pass https://yyy/;
>        proxy_set_header Upgrade $http_upgrade;
>        proxy_set_header Connection $connection_upgrade;
>      }
>    ...
>    }
>}
>```

Если при внесении проекта в Nginx возникают проблемы, лучшее решение — запустить проект локально и с помощью вкладки «‎Cеть» инструментов разработчика в веб-браузере посмотреть, на какие адреса идут запросы, и отталкиваться от этого.

В файлах проекта на всякий случай оставлены закомментированными строчки, оставшиеся от Nginx'a на прошлом сервере.